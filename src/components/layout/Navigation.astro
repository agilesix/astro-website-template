---
import DesktopNavigation from "@/components/layout/DesktopNavigation.astro";
import MobileNavigation from "@/components/layout/MobileNavigation.astro";

interface NavItem {
  label: string;
  href: string;
}

interface NavDropdown {
  label: string;
  items: NavItem[];
}

interface NavigationProps {
  logo?: string;
  logoHref?: string;
  items: (NavItem | NavDropdown)[];
}

const { logo, logoHref = "/", items } = Astro.props;
---

<nav
  class="bg-background border-b border-border relative transition-colors nav-theme"
  role="navigation"
  aria-label="Main navigation"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <div class="shrink-0">
        <a
          href={logoHref}
          class="text-2xl font-bold text-foreground hover:text-foreground/80 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 rounded transition-colors"
          aria-label={`${logo || "Company Name"} - Home`}
        >
          {logo || "Company Name"}
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex md:items-center md:space-x-4">
        <DesktopNavigation items={items} />

        <!-- Theme Selector Dropdown -->
        <div class="relative group ml-4" role="none">
          <button
            id="theme-selector-button"
            class="text-foreground hover:text-foreground/80 px-3 py-2 text-sm font-medium flex items-center focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 rounded transition-colors"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="theme-selector-menu"
            role="menuitem"
            type="button"
          >
            <svg
              class="w-4 h-4 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
              ></path>
            </svg>
            <span id="theme-selector-label">Theme</span>
            <svg
              class="ml-1 h-4 w-4 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div
            id="theme-selector-menu"
            class="absolute right-0 mt-2 w-48 bg-popover text-popover-foreground border border-border rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible focus-within:opacity-100 focus-within:visible transition-all duration-200 z-20"
            role="menu"
            aria-labelledby="theme-selector-button"
          >
            <div class="py-1">
              <button
                data-theme-option="trustworthy"
                class="w-full text-left px-4 py-2 text-sm text-popover-foreground hover:bg-accent focus:outline-none focus:ring-2 focus:ring-inset focus:ring-ring transition-colors flex items-center justify-between"
                role="menuitem"
                tabindex="-1"
              >
                <span>Trustworthy</span>
                <svg
                  class="w-4 h-4 hidden theme-check-icon"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>
              <button
                data-theme-option="playful"
                class="w-full text-left px-4 py-2 text-sm text-popover-foreground hover:bg-accent focus:outline-none focus:ring-2 focus:ring-inset focus:ring-ring transition-colors flex items-center justify-between"
                role="menuitem"
                tabindex="-1"
              >
                <span>Playful</span>
                <svg
                  class="w-4 h-4 hidden theme-check-icon"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>
              <button
                data-theme-option="innovative"
                class="w-full text-left px-4 py-2 text-sm text-popover-foreground hover:bg-accent focus:outline-none focus:ring-2 focus:ring-inset focus:ring-ring transition-colors flex items-center justify-between"
                role="menuitem"
                tabindex="-1"
              >
                <span>Innovative</span>
                <svg
                  class="w-4 h-4 hidden theme-check-icon"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div class="md:hidden flex items-center space-x-2">
        <!-- Theme Selector Button (Mobile) -->
        <button
          id="theme-selector-button-mobile"
          class="p-2 text-foreground hover:text-foreground/80 hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 rounded transition-colors"
          aria-label="Theme selector"
          aria-haspopup="true"
          aria-expanded="false"
          aria-controls="theme-selector-menu-mobile"
          type="button"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
            ></path>
          </svg>
        </button>
        <MobileNavigation items={items} />
      </div>
    </div>
  </div>
</nav>

<!-- Mobile Theme Selector Menu -->
<div
  id="theme-selector-menu-mobile"
  class="fixed inset-0 z-50 md:hidden pointer-events-none"
  role="dialog"
  aria-modal="true"
  aria-label="Theme selector"
  aria-hidden="true"
>
  <div
    id="theme-selector-backdrop"
    class="fixed inset-0 bg-black bg-opacity-50 transition-opacity duration-300 opacity-0 pointer-events-none"
    aria-hidden="true"
  >
  </div>
  <div
    id="theme-selector-panel"
    class="fixed right-0 top-0 h-full w-full max-w-sm bg-popover text-popover-foreground shadow-xl transform transition-transform duration-300 ease-in-out translate-x-full overflow-y-auto pointer-events-auto"
  >
    <div class="flex items-center justify-between p-4 border-b border-border">
      <h2 class="text-lg font-semibold text-popover-foreground">Theme</h2>
      <button
        id="theme-selector-close"
        class="text-popover-foreground hover:text-popover-foreground/80 p-2 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 rounded transition-colors"
        aria-label="Close theme selector"
      >
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="p-4 space-y-2">
      <button
        data-theme-option="trustworthy"
        class="w-full text-left px-4 py-3 text-sm text-popover-foreground hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring focus:ring-inset rounded transition-colors flex items-center justify-between"
        role="menuitem"
      >
        <span>Trustworthy</span>
        <svg
          class="w-4 h-4 hidden theme-check-icon-mobile"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
      <button
        data-theme-option="playful"
        class="w-full text-left px-4 py-3 text-sm text-popover-foreground hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring focus:ring-inset rounded transition-colors flex items-center justify-between"
        role="menuitem"
      >
        <span>Playful</span>
        <svg
          class="w-4 h-4 hidden theme-check-icon-mobile"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
      <button
        data-theme-option="innovative"
        class="w-full text-left px-4 py-3 text-sm text-popover-foreground hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring focus:ring-inset rounded transition-colors flex items-center justify-between"
        role="menuitem"
      >
        <span>Innovative</span>
        <svg
          class="w-4 h-4 hidden theme-check-icon-mobile"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // Theme management functionality
  (function () {
    const THEME_STORAGE_KEY = "theme-preference";
    const THEME_ATTRIBUTE = "data-theme";

    const THEMES = ["trustworthy", "playful", "innovative"];

    // Get the initial theme preference
    function getThemePreference(): string {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      if (stored && THEMES.includes(stored)) {
        return stored;
      }
      // Default to innovative
      return "innovative";
    }

    // Apply theme to document
    function applyTheme(theme: string) {
      const root = document.documentElement;
      root.setAttribute(THEME_ATTRIBUTE, theme);
      localStorage.setItem(THEME_STORAGE_KEY, theme);
      updateThemeUI();
    }

    // Update theme UI (labels, checkmarks)
    function updateThemeUI() {
      const currentTheme =
        document.documentElement.getAttribute(THEME_ATTRIBUTE) || "innovative";

      // Update theme selector label
      const themeLabel = document.getElementById("theme-selector-label");
      if (themeLabel) {
        themeLabel.textContent =
          currentTheme.charAt(0).toUpperCase() + currentTheme.slice(1);
      }

      // Update checkmarks
      document.querySelectorAll("[data-theme-option]").forEach((button) => {
        const option = button.getAttribute("data-theme-option");
        const checkIcon = button.querySelector(".theme-check-icon");
        const checkIconMobile = button.querySelector(
          ".theme-check-icon-mobile"
        );

        if (option === currentTheme) {
          checkIcon?.classList.remove("hidden");
          checkIconMobile?.classList.remove("hidden");
        } else {
          checkIcon?.classList.add("hidden");
          checkIconMobile?.classList.add("hidden");
        }
      });
    }

    // Set theme
    function setTheme(theme: string) {
      applyTheme(theme);
    }

    // Initialize theme on page load
    function initTheme() {
      const theme = getThemePreference();
      applyTheme(theme);
    }

    // Initialize theme and icons after DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initTheme);
    } else {
      initTheme();
    }

    // Set up event listeners after DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      // Desktop theme selector dropdown
      const themeSelectorButton = document.getElementById(
        "theme-selector-button"
      );
      const themeSelectorMenu = document.getElementById("theme-selector-menu");

      if (themeSelectorButton && themeSelectorMenu) {
        // Toggle dropdown on click
        themeSelectorButton.addEventListener("click", (e) => {
          e.preventDefault();
          const isExpanded =
            themeSelectorButton.getAttribute("aria-expanded") === "true";
          themeSelectorButton.setAttribute(
            "aria-expanded",
            String(!isExpanded)
          );
          themeSelectorMenu.classList.toggle("opacity-0", isExpanded);
          themeSelectorMenu.classList.toggle("invisible", isExpanded);
          themeSelectorMenu.classList.toggle("opacity-100", !isExpanded);
          themeSelectorMenu.classList.toggle("visible", !isExpanded);
        });

        // Theme option buttons
        document.querySelectorAll("[data-theme-option]").forEach((button) => {
          button.addEventListener("click", () => {
            const theme = button.getAttribute("data-theme-option");
            if (theme) {
              setTheme(theme);
              // Close dropdown
              themeSelectorButton.setAttribute("aria-expanded", "false");
              themeSelectorMenu.classList.add("opacity-0", "invisible");
              themeSelectorMenu.classList.remove("opacity-100", "visible");
            }
          });
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !themeSelectorButton.contains(e.target as Node) &&
            !themeSelectorMenu.contains(e.target as Node)
          ) {
            themeSelectorButton.setAttribute("aria-expanded", "false");
            themeSelectorMenu.classList.add("opacity-0", "invisible");
            themeSelectorMenu.classList.remove("opacity-100", "visible");
          }
        });
      }

      // Mobile theme selector
      const themeSelectorButtonMobile = document.getElementById(
        "theme-selector-button-mobile"
      );
      const themeSelectorMenuMobile = document.getElementById(
        "theme-selector-menu-mobile"
      );
      const themeSelectorBackdrop = document.getElementById(
        "theme-selector-backdrop"
      );
      const themeSelectorPanel = document.getElementById(
        "theme-selector-panel"
      );
      const themeSelectorClose = document.getElementById(
        "theme-selector-close"
      );

      if (
        themeSelectorButtonMobile &&
        themeSelectorMenuMobile &&
        themeSelectorBackdrop &&
        themeSelectorPanel
      ) {
        const openMobileMenu = () => {
          themeSelectorMenuMobile.setAttribute("aria-hidden", "false");
          themeSelectorMenuMobile.classList.remove("pointer-events-none");
          themeSelectorButtonMobile.setAttribute("aria-expanded", "true");
          themeSelectorBackdrop.classList.remove(
            "opacity-0",
            "pointer-events-none"
          );
          themeSelectorBackdrop.classList.add(
            "opacity-100",
            "pointer-events-auto"
          );
          themeSelectorPanel.classList.remove("translate-x-full");
          themeSelectorPanel.classList.add("translate-x-0");
          document.body.style.overflow = "hidden";
          setTimeout(() => themeSelectorClose?.focus(), 100);
        };

        const closeMobileMenu = () => {
          themeSelectorMenuMobile.setAttribute("aria-hidden", "true");
          themeSelectorMenuMobile.classList.add("pointer-events-none");
          themeSelectorButtonMobile.setAttribute("aria-expanded", "false");
          themeSelectorBackdrop.classList.remove(
            "opacity-100",
            "pointer-events-auto"
          );
          themeSelectorBackdrop.classList.add(
            "opacity-0",
            "pointer-events-none"
          );
          themeSelectorPanel.classList.remove("translate-x-0");
          themeSelectorPanel.classList.add("translate-x-full");
          document.body.style.overflow = "";
          themeSelectorButtonMobile?.focus();
        };

        themeSelectorButtonMobile.addEventListener("click", openMobileMenu);
        themeSelectorClose?.addEventListener("click", closeMobileMenu);
        themeSelectorBackdrop.addEventListener("click", closeMobileMenu);

        // Theme option buttons (mobile)
        document.querySelectorAll("[data-theme-option]").forEach((button) => {
          button.addEventListener("click", () => {
            const theme = button.getAttribute("data-theme-option");
            if (theme) {
              setTheme(theme);
              closeMobileMenu();
            }
          });
        });

        // Close on Escape
        themeSelectorMenuMobile.addEventListener("keydown", (e) => {
          if ((e as KeyboardEvent).key === "Escape") {
            closeMobileMenu();
          }
        });
      }
    });
  })();
</script>
